<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC QR Code</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <h1>WebRTC QR Code</h1>
    <video id="localVideo" autoplay muted style="width: 320px; height: 240px;"></video>
    <video id="remoteVideo" autoplay style="width: 320px; height: 240px;"></video>
    <div id="qrCodeContainer"></div>

    <script>
        let localStream;
        let peerConnection;
        let qrCode;

        // Generate QR code with client ID as URL parameter
        function generateQRCode(clientId, offer) {
            const url = window.location.href.split('?')[0] + `?clientId=${clientId}&offer=${encodeURIComponent(JSON.stringify(offer))}`;
            qrCode = new QRCode(document.getElementById('qrCodeContainer'), url);
        }

        // Start the connection
        function startConnection(clientId, offer) {
            // Create a peer connection object
            peerConnection = new RTCPeerConnection();

            // Add the local stream to the connection
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Handle incoming streams
            peerConnection.ontrack = event => {
                const remoteVideo = document.getElementById('remoteVideo');
                if (!remoteVideo.srcObject) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            // Handle ICE candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    sendSignal({
                        type: 'candidate',
                        candidate: event.candidate
                    });
                }
            };

            // Set remote description
            peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
                .then(() => peerConnection.createAnswer())
                .then(answer => peerConnection.setLocalDescription(answer))
                .then(() => {
                    sendSignal({
                        type: 'answer',
                        answer: peerConnection.localDescription
                    });
                })
                .catch(error => console.error('Error creating answer:', error));
        }

        // Get user media for local video
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;

                // Extract client ID and offer from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const clientId = urlParams.get('clientId');
                const offerParam = urlParams.get('offer');

                if (clientId && offerParam) {
                    const offer = JSON.parse(decodeURIComponent(offerParam));
                    startConnection(clientId, offer);
                } else {
                    // If no client ID or offer, generate one and start the connection
                    const newClientId = generateClientId();
                    const offer = await createOffer();
                    generateQRCode(newClientId, offer);
                }
            })
            .catch(error => {
                console.error('Error accessing webcam:', error);
            });

        // Generate a random client ID
        function generateClientId() {
            return Math.random().toString(36).substring(7);
        }

        // Create offer
        async function createOffer() {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            return offer;
        }

        // Send signaling data to the other peer
        function sendSignal(data) {
            const signal = JSON.stringify(data);
            // Simulate sending the signal (in a real scenario, you'd send this to the other peer)
            alert('Signal to be sent: ' + signal);
        }
    </script>
</body>
</html>
